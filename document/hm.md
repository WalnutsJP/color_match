# Histogram Matching

--------------------------------------------------

## ■概要

入力画像のヒストグラムを参照画像のヒストグラムに合わせる古典的なカラーマッチング手法

--------------------------------------------------

## ■基本原理

ヒストグラムマッチングは、以下の考え方に基づいています：

1. 対象画像と参照画像の**ヒストグラム**(各ピクセル値の度数分布)を計算

2. 2つの画像のヒストグラムの **累積分布関数(CDF)** を計算  
  累積分布関数(Cumulative Distribution Function)は確率変数がある値以下の値となる確率を表す関数です

3. $CDF_{\text{src}}(x) \approx CDF_{\text{ref}}(y)$ となる $y$ を求めることで、入力画像 $x$ と $y$ の分布を揃えます:  
  $$y = CDF_{\text{ref}}^{-1}(CDF_{\text{src}}(x))$$
  ※実装では累積分布関数(CDF)の変換を LUT（Look-Up Table）ベースで処理

--------------------------------------------------

## ■実装上の詳細

1. チャンネルデータを1次元配列に変換

```python
src = src_chan.ravel()
ref = ref_chan.ravel()
```

2. ヒストグラムの計算

```python
src_hist = np.bincount(src, minlength=256)
ref_hist = np.bincount(ref, minlength=256)
```

- `bincount()` を使用して、非負整数の各ピクセル値の出現回数をカウント
- `minlength=256` で256段階のヒストグラムを保証

3. CDFの計算

```python
src_cdf = np.cumsum(src_hist)   # ヒストグラムの累積和(累積ヒストグラム)を計算
src_cdf /= src_cdf[-1]          # [0, 1]の範囲に正規化してCDFを計算
ref_cdf = np.cumsum(ref_hist)
ref_cdf /= ref_cdf[-1]
```

- numpy.cumsum(x)は引数xの累積和(先頭要素から自身の要素までの総和)を計算する
- 末尾の累積和で全体を除算することで[0, 1]の範囲に正規化してCDFを計算する

4. ヒストグラムマッチングの適応

```python
lut = np.interp(src_cdf, ref_cdf, np.arange(256)).astype(np.uint8)
return lut[src_chan]
```

- `numpy.interp(x, xp, yp)` は離散データポイント (xp, yp) を持つ関数(データポイント間は線形補間)を元にxの位置のypを求める
- (xp, yp) に (ref_cdf, np.arange(N)) (Nはヒストグラムの階調数)を渡すことで離散データポイント(xp, yp)を持つ関数は $CDF_{\text{ref}}(y)^{-1}$ としてはたらく 

--------------------------------------------------

## ■特徴とトレードオフ

### 利点

- 計算量は線形
  - **時間計算量**: $O(H \times W)$ + $O(N)$  
    H: 画像の幅  
    W: 画像の高さ  
    N: ヒストグラムの階調数
  - **空間計算量**: $O(N)$
- 数値的に安定

### 欠点

- 参照画像に極端なピクセル値があるとそのような癖までコピーされてしまい、色アーティファクトが生じる
- 実装では `np.interp` で線形補間を使用しているため、ヒストグラムの段階が疎な場合に急激な値の跳躍が生じる
